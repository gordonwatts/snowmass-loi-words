<!-- Code from d3-graph-gallery.com -->
<!DOCTYPE html>
<head>
    <style type="text/css">

    div.tooltip {
        position: absolute;
        text-align: left;
        background-color: white;
        border: solid 2px;
        border-radius: 5px;
        padding: 5px;
    }
    </style>
</head>
<body>
    <meta charset="utf-8">
    <!-- Create a div where the graph will take place -->
    <div id="my_dataviz"></div>

    <input id="search" style="visibility: hidden;" placeholder="Single Word Search Term"/>

    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script type="text/javascript">

    // set the dimensions and margins of the graph
    var margin = {top: 50, right: 30, bottom: 50, left: 60},
        width = window.innerWidth - margin.left - margin.right - 100,
        height = window.innerHeight - margin.top - margin.bottom - 100;

    // Color scale: give me a specie name, I return a color
    var color = d3.scaleOrdinal()
      .domain(["AF", "CF", "CommF", "CompF", "EF", "IF", "NF", "RF", "TF", "UF" ])
      .range(["#A2BA83",  "#639F82", "#3E3F3E", "#94544B", "#BE0A27", "#07A2C7", "#D2A26D", "#C2B257", "#A8A148", "#F08012"])

    // Gets us back to "ground zero"
    function reset_colors() {
      d3.selectAll(".dot")
          .transition()
          .duration(200)
          .style("fill", function (d) { return color(d.area) })
          .attr("r", 5 )
    }

    // State of the page:
    // 0 - Mouse over should work as normal
    // 1 - Valid search term: mouse over disabled.
    state = 0

    // if this list is empty, display tool tips for everything. Otherwise, just for
    // the index in this list
    tool_tip_only_documents = []

    // append the svg object to the body of the page
    var svg = d3.select("#my_dataviz")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

    //Read the scatter plot data
    d3.csv("../data/loi-data.csv", function(data) {

      // Add X axis
      var x = d3.scaleLinear()
        .domain([-0.4, 0.6])
        .range([ 0, width ]);
      svg.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

      // Add Y axis
      var y = d3.scaleLinear()
        .domain([-0.4, 0.6])
        .range([ height, 0]);
      svg.append("g")
        .call(d3.axisLeft(y));

      // Names of the frontiers for people like me who can't keep track of them all:
      var frontiers = {
        "AF": "Accelerator",
        "CF": "Cosmic",
        "CommF": "Community Engagement",
        "CompF": "Computational",
        "EF": "Energy",
        "IF": "Instrumentation",
        "NF": "Neutrino Physics",
        "RF": "Rare Processes and Precision",
        "TF": "Theory",
        "UF": "Underground Facilities"
      }

      // Create the tool tip that we'll use to display info
      var Tooltip = d3.select("body").append("div")
        .style("opacity", 0)
        .style("display", "none")
        .attr("class", "tooltip");

      // Call back when we mouse over an area - high light everything from that area
      var highlight = function(d) {

        selected_area = d.area

        // Get a little blob of info text
        if (tool_tip_only_documents.length == 0 || tool_tip_only_documents.indexOf(d.index) > 0){
          Tooltip
            .html(d.name + "<br>Click for PDF<br>Frontier: " + frontiers[d.area] + "<br>" + d.summary)
            .style("opacity", 1)
            .style("display", "inline")
            .style("left", (d3.event.pageX + 20) + "px")
            // NB: offset in y so it doesn't cover the data point and trigger a mouseout event
            .style("top", (d3.event.pageY - 50) + "px");
        }

        if (state == 0) {
          // Turn them all to gray
          d3.selectAll(".dot")
            .transition()
            .duration(200)
            .style("fill", "lightgrey")
            .attr("r", 3);

          // For the ones with our color, turn them bigger so they are easy to spot
          d3.selectAll("." + selected_area)
            .transition()
            .duration(200)
            .style("fill", color(selected_area))
            .attr("r", 7);
        }
      };

      // Ok - turn off the highlighting
      var doNotHighlight = function(){
        // Tool tip
        Tooltip
          .style("opacity", 0)
          .style("display", "none")

        // Reset the dots to their "normal" state
        if (state == 0) {
          reset_colors()
        }
      };

      var doClick = function(d) {
        window.open(d.url)
      };

      // Add dots, one for each data point
      svg.append('g')
        .selectAll("dot")
        .data(data)
        .enter()
        .append("circle")
          .attr("class", d => "dot + " + d.area)
          .attr("cx", d => x(d.x) )
          .attr("cy", d => y(d.y) )
          .attr("r", 5)
          .style("fill", d => color(d.area) )
        .on("mouseenter", highlight)
        .on("click", doClick)
        .on("mouseleave", doNotHighlight);
    })

    // Load in the term data to power search
    d3.json('../data/term_data.json', function (data) {

      // User has entered something. Highlight if we know it
      function lookup_keyword() {
        word = this.value
        if (data[word]) {
          // Shift state so that we are correctly tracking the marked dots
          state = 1

          // highlight the dots for each word
          ids = data[word];
          tool_tip_only_documents = Object.keys(ids)

          d3.selectAll(".dot")
            .transition()
            .duration(200)
            .style("fill", d => {
              if (ids[d.index]) {
                return color(d.area)
              } else {
                return "lightgrey"
              }
            })
            .attr("r", d => {
              if (ids[d.index]) {
                return 7
              } else {
                return 3
              }
            })

        } else {
          // No longer looking at a good search. Make sure it is disabled.
          if (state == 1) {
            reset_colors()
            tool_tip_only_documents = []
            state = 0
          }
        }
      }

      d3.select("#search")
        .style("visibility", "visible" )
        .on("input", lookup_keyword)
    })

    </script>
</body>
